# EmailHub 使用指南

## 📖 目录

1. [快速开始](#快速开始)
2. [新用户完整配置流程](#新用户完整配置流程)
3. [功能详解](#功能详解)
4. [常见场景配置](#常见场景配置)
5. [故障排查](#故障排查)

---

## 🚀 快速开始

### 1. 启动系统

```bash
# 安装依赖
npm install

# 初始化数据库
npx prisma generate
npx prisma db push

# 启动开发服务器
npm run dev
```

访问 http://localhost:3000

### 2. 注册账号

1. 点击首页的"开始使用"按钮
2. 在登录页面点击"注册新账号"
3. 填写邮箱和密码（密码至少 6 位）
4. 点击"注册"按钮

---

## 🎯 新用户完整配置流程

### 场景：将 Gmail 邮件推送到飞书群

#### 第一步：添加邮箱账户

1. **登录后进入仪表盘**
   - 点击左侧菜单的"邮箱管理"

2. **点击"添加邮箱"按钮**

3. **填写邮箱信息**
   ```
   邮箱地址: your-email@gmail.com
   密码: 你的应用专用密码（不是登录密码！）
   提供商: Gmail
   ```

4. **获取 Gmail 应用专用密码**
   - 访问 https://myaccount.google.com/apppasswords
   - 登录你的 Google 账号
   - 选择"邮件"和"其他设备"
   - 点击"生成"
   - 复制生成的 16 位密码（格式：xxxx xxxx xxxx xxxx）
   - 粘贴到 EmailHub 的密码框（去掉空格）

5. **IMAP 配置（Gmail 自动填充）**
   ```
   IMAP 主机: imap.gmail.com
   IMAP 端口: 993
   ```

6. **点击"保存"**
   - 系统会自动测试连接
   - 成功后显示绿色"已连接"状态

#### 第二步：创建飞书推送渠道

1. **进入"推送渠道"页面**
   - 点击左侧菜单的"推送渠道"

2. **点击"新建渠道"按钮**

3. **选择"飞书"类型**

4. **获取飞书 Webhook URL**
   - 打开飞书 PC 客户端
   - 进入你想接收通知的群聊
   - 点击右上角"设置" → "群机器人"
   - 点击"添加机器人" → "自定义机器人"
   - 设置机器人名称（如"邮件助手"）
   - 复制生成的 Webhook 地址
   - 示例：`https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxx`

5. **填写渠道信息**
   ```
   渠道名称: 飞书工作群
   Webhook URL: [粘贴刚才复制的地址]
   ```

6. **（可选）自定义消息模板**
   ```
   默认模板已经很好用，包含：
   - 发件人
   - 主题
   - 正文预览
   - 接收时间
   ```

7. **点击"保存"**
   - 系统会发送测试消息到飞书群
   - 检查飞书群是否收到测试消息

#### 第三步：创建过滤规则

1. **进入"过滤规则"页面**
   - 点击左侧菜单的"过滤规则"

2. **点击"新建规则"按钮**

3. **配置规则示例 1：推送所有邮件**
   ```
   规则名称: 推送所有邮件到飞书
   优先级: 0

   条件设置:
   - 不填写任何条件（留空表示匹配所有邮件）

   操作设置:
   ✓ 推送到渠道: 选择"飞书工作群"
   ```

4. **配置规则示例 2：只推送重要邮件**
   ```
   规则名称: 重要邮件推送
   优先级: 10

   发件人条件:
   - @company.com
   - boss@example.com

   主题关键词:
   - 紧急
   - 重要
   - URGENT

   操作设置:
   ✓ 推送到渠道: 选择"飞书工作群"
   ```

5. **配置规则示例 3：过滤垃圾邮件**
   ```
   规则名称: 广告邮件拦截
   优先级: 5

   主题关键词:
   - 广告
   - 促销
   - 优惠券

   操作设置:
   ✓ 标记为已读
   ✓ 直接删除
   ```

6. **点击"创建规则"**

#### 第四步：启动邮件监听

1. **返回"邮箱管理"页面**

2. **找到刚才添加的 Gmail 账户**

3. **点击"启动监听"按钮**
   - 状态变为"监听中"（绿色）
   - 系统开始实时监听新邮件

4. **测试推送**
   - 给你的 Gmail 发送一封测试邮件
   - 等待 5-10 秒
   - 检查飞书群是否收到推送消息
   - 检查 EmailHub 仪表盘是否显示新邮件

#### 第五步：查看推送记录

1. **进入"统计分析"页面**
   - 查看推送成功率
   - 查看邮件接收趋势
   - 查看各渠道推送统计

2. **查看邮件详情**
   - 在仪表盘点击任意邮件
   - 查看完整邮件内容
   - 查看该邮件的推送记录

---

## 📚 功能详解

### 1. 仪表盘

**功能**：
- 显示最近收到的邮件列表
- 快速查看未读邮件数量
- 点击邮件查看详情

**操作**：
- 🔵 蓝色圆点 = 未读邮件
- 点击邮件卡片 → 查看详情
- 邮件详情页可以：
  - 标记为未读
  - 删除邮件
  - 查看附件
  - 查看推送日志

### 2. 邮箱管理

**支持的邮箱类型**：
- Gmail
- Outlook/Hotmail
- QQ 邮箱
- 163 邮箱
- 自定义 IMAP

**常用邮箱配置**：

| 邮箱类型 | IMAP 主机 | IMAP 端口 | 备注 |
|---------|-----------|-----------|------|
| Gmail | imap.gmail.com | 993 | 需要应用专用密码 |
| Outlook | outlook.office365.com | 993 | 需要应用专用密码 |
| QQ 邮箱 | imap.qq.com | 993 | 需要开启 IMAP 并获取授权码 |
| 163 邮箱 | imap.163.com | 993 | 需要开启 IMAP 并获取授权码 |

**获取授权码/应用密码**：

- **Gmail**：https://myaccount.google.com/apppasswords
- **Outlook**：https://account.live.com/proofs/AppPassword
- **QQ 邮箱**：邮箱设置 → 账户 → POP3/IMAP/SMTP 服务 → 生成授权码
- **163 邮箱**：邮箱设置 → POP3/SMTP/IMAP → 开启 IMAP 服务 → 获取授权码

### 3. 推送渠道

**支持的推送类型**：
- 企业微信（WeCom）
- 飞书（Lark/Feishu）
- Telegram

**获取 Webhook URL**：

#### 企业微信
1. 进入企业微信群聊
2. 右键点击群聊 → 添加群机器人
3. 选择"自定义机器人"
4. 复制 Webhook 地址

#### 飞书
1. 进入飞书群聊
2. 设置 → 群机器人 → 添加机器人
3. 选择"自定义机器人"
4. 复制 Webhook 地址

#### Telegram
1. 与 @BotFather 对话
2. 发送 `/newbot` 创建机器人
3. 获取 Bot Token
4. 获取你的 Chat ID（可以用 @userinfobot）
5. 在 EmailHub 填写：
   - Bot Token: `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`
   - Chat ID: `123456789`

### 4. 过滤规则

**规则优先级**：
- 数字越大，优先级越高
- 高优先级规则先执行
- 建议：垃圾邮件过滤 = 5，重要邮件 = 10，普通邮件 = 0

**条件匹配逻辑**：
- 同一类型条件：OR（满足任一即可）
- 不同类型条件：AND（必须全部满足）
- 示例：
  ```
  发件人包含: @company.com 或 boss@example.com
  且
  主题包含: 紧急 或 重要
  ```

**操作类型**：
- ✅ 标记为已读：自动标记邮件为已读状态
- 🗑️ 直接删除：自动删除匹配的邮件
- 📤 推送到渠道：发送通知到指定渠道（可多选）

### 5. 统计分析

**查看数据**：
- 📊 推送成功率：各渠道的推送成功/失败统计
- 📈 邮件趋势：每日邮件接收数量趋势图
- 🔔 推送统计：各渠道的推送次数排行
- ⚡ 实时监控：当前监听状态和最近活动

### 6. 系统设置

**个人资料**：
- 修改用户名
- 修改密码

**通知设置**：
- 邮件通知开关
- 推送通知开关
- 声音提示开关
- 免打扰时段设置

**推送频率限制**：
- 每分钟最多推送次数（防止刷屏）
- 每小时最多推送次数
- 建议：每分钟 10 次，每小时 100 次

**安全设置**：
- 双因素认证（开发中）
- 会话超时时间

**界面设置**：
- 语言选择
- 时区设置
- 日期格式

---

## 🎨 常见场景配置

### 场景 1：工作邮件推送到企业微信

```
邮箱: work@company.com
渠道: 企业微信工作群
规则:
  名称: 工作邮件推送
  发件人: @company.com, @client.com
  操作: 推送到企业微信工作群
```

### 场景 2：账单邮件推送到 Telegram

```
邮箱: personal@gmail.com
渠道: Telegram 个人机器人
规则:
  名称: 账单提醒
  主题关键词: 账单, 发票, bill, invoice
  操作: 推送到 Telegram
```

### 场景 3：多邮箱统一管理

```
邮箱 1: work@company.com
邮箱 2: personal@gmail.com
邮箱 3: side-project@outlook.com

渠道 1: 企业微信（工作邮件）
渠道 2: 飞书（个人邮件）
渠道 3: Telegram（项目邮件）

规则 1: 工作邮件 → 企业微信
规则 2: 个人邮件 → 飞书
规则 3: 项目邮件 → Telegram
```

### 场景 4：智能过滤垃圾邮件

```
规则 1: 广告邮件拦截
  优先级: 10
  主题关键词: 广告, 促销, 优惠, 打折
  操作: 标记已读 + 删除

规则 2: 订阅邮件归档
  优先级: 5
  发件人: noreply@, newsletter@
  操作: 标记已读

规则 3: 重要邮件推送
  优先级: 15
  发件人: boss@, hr@, finance@
  操作: 推送到所有渠道
```

### 场景 5：按时间段推送

```
通知设置:
  免打扰时段: 22:00 - 08:00

规则:
  名称: 工作时间推送
  条件: 所有邮件
  操作: 推送到飞书

说明: 系统会自动在免打扰时段内静音推送
```

---

## 🔧 故障排查

### 问题 1：邮箱连接失败

**可能原因**：
1. 密码错误（使用了登录密码而非应用专用密码）
2. IMAP 服务未开启
3. IMAP 主机或端口配置错误

**解决方法**：
1. 确认使用的是应用专用密码/授权码
2. 检查邮箱设置中 IMAP 服务是否已开启
3. 核对 IMAP 配置信息
4. 检查防火墙是否阻止了 993 端口

### 问题 2：收不到推送通知

**可能原因**：
1. 推送渠道配置错误
2. 过滤规则未匹配
3. 邮件监听未启动
4. Webhook URL 失效

**解决方法**：
1. 在"推送渠道"页面点击"测试"按钮
2. 检查过滤规则的条件设置
3. 确认邮箱状态为"监听中"
4. 重新获取 Webhook URL 并更新

### 问题 3：推送延迟

**可能原因**：
1. IMAP IDLE 连接断开
2. 服务器负载过高
3. 网络延迟

**解决方法**：
1. 重启邮件监听
2. 检查服务器资源使用情况
3. 检查网络连接

### 问题 4：重复推送

**可能原因**：
1. 多条规则匹配同一邮件
2. 邮件监听重复启动

**解决方法**：
1. 检查过滤规则，避免条件重叠
2. 停止所有监听后重新启动
3. 设置推送频率限制

### 问题 5：邮件未显示在仪表盘

**可能原因**：
1. 过滤规则设置了"直接删除"
2. 数据库同步延迟
3. 邮件监听未正常工作

**解决方法**：
1. 检查过滤规则的操作设置
2. 刷新页面
3. 查看"统计分析"中的邮件接收记录

---

## 💡 最佳实践

### 1. 规则设计原则

- ✅ 从具体到一般：高优先级规则处理特殊情况，低优先级处理通用情况
- ✅ 避免规则冲突：确保每封邮件只被一条规则处理
- ✅ 定期清理：删除不再使用的规则
- ✅ 测试验证：创建规则后发送测试邮件验证

### 2. 推送频率控制

- ✅ 设置合理的频率限制（建议：10/分钟，100/小时）
- ✅ 使用免打扰时段避免夜间打扰
- ✅ 重要邮件单独推送，普通邮件可以批量推送

### 3. 安全建议

- ✅ 定期更换应用专用密码
- ✅ 不要在公共场所使用
- ✅ 定期检查推送日志，发现异常及时处理
- ✅ 使用强密码保护 EmailHub 账户

### 4. 性能优化

- ✅ 不要同时监听过多邮箱（建议 ≤ 5 个）
- ✅ 定期清理旧邮件数据
- ✅ 合理设置过滤规则，避免过度复杂

---

## 📞 获取帮助

如果遇到问题：

1. 查看本使用指南的"故障排查"部分
2. 查看系统日志（开发者工具 Console）
3. 提交 Issue 到 GitHub 仓库
4. 联系技术支持

---

## 🎉 快速上手检查清单

- [ ] 注册并登录账户
- [ ] 添加至少一个邮箱账户
- [ ] 创建至少一个推送渠道
- [ ] 创建至少一个过滤规则
- [ ] 启动邮件监听
- [ ] 发送测试邮件验证推送
- [ ] 查看统计分析数据
- [ ] 配置系统设置

完成以上步骤后，你的 EmailHub 就配置完成了！🎊
